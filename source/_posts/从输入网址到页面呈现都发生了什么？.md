---
title: 从输入网址到页面呈现都发生了什么？
date: 2018-05-09 10:23:04
categories: javascript
tags: http
---

涉及到网络通信和页面渲染

## 网络通信

如果输入的地址是域名：www.baidu.com

#### 域名解析（DNS解析）：

  1.先检查本地hosts文件有没有域名对应的ip映射，如果有直接调用这个映射到的ip，域名解析完成
  2.如果hosts文件没有相应的映射，查找本地DNS解析缓存，如果有直接返回，解析完成
  3.如果hosts文件和本地DNS解析缓存都没有相应的网址映射，则查找本地DNS服务器（TCP/IP参数中设置的首选DNS服务器），如果域名包含在本地DNS服务器配置中，则返回相应的IP给客户机，完成解析
  4.如果本地DNS服务器配置中没有相应的映射，则查找本地DNS服务器缓存是否存在网址映射关系，有则返回IP，完成域名解析
  5.如果本地DNS服务器和缓存都没有相应的映射关系，如果本地DNS服务器未用转发模式
      本地DNS会把请求发给13台根DNS,
      根DNS收到请求，会查询.com是谁来授权管理的，返回负责这个顶级域名服务器的Ip给本地DNS服务器
      本地DNS服务器收到这个ip以后，发送请求给这台服务器
      这台负责.com域的服务器如果无法解析，则找.com域的下一级也就是授权管理baidu.com的DNS服务器的ip给本地DNS服务器
      本地DNS服务器收到这个ip以后，发送请求给这台服务器，重复这个操作
  6.如果用的时转发模式，
      本地DNS会把请求发给上一级DNS服务器,交给上一级解析
      如果上一级不能解析，交给上上级解析，没有上上级则查找根DNS服务器，也就是5的操作
  7.不管是不是转发模式，最终都会把域名解析的地址返回给本地DNS服务器，本地DNS服务器再返回给客户端


#### 应用层客户端发送http请求

http请求包含报文头和请求主体

报文头包含了重要的信息：请求方式，请求地址，遵循的协议，是否需要缓存，客户端是否发送cookie等

#### 传输层 确保传输报文可靠性的tcp协议

tcp协议通过三次握手保证传输的可靠

- 发送端发送一个包含SYN(synchronize)标志的数据包给接收端，在一定延迟时间内等待回复

- 接收端接收到以后，返回一个SYC/ACK标志的数据包表示确认

- 发送方收到以后，发送一个带有ACK标志的数据包给接收端，表示握手成功

如果发送方在延迟时间内不能收到回复，默认接收方没有收到请求，会再次发送，直到收到请求

如果三次握手不能顺利进行，则不能建立连接

tcp把大块数据分割成报文段为单位的数据包并编号进行传输，方便服务器还原数据信息

#### 网络层 负责传输的IP协议

IP协议负责把tcp协议分割的数据包传给接收方，需要保证传输正确，还需要找到接收方的mac地址，也就是物理地址。

一个网络设备的mac地址和IP是一一对应的，IP会变但是mac不变

ARP协议将ip地址解析成对应的mac地址

当发送方和接收方不在同一个局域网，需要多次中转才能到达最终目标

#### 数据链路层

找到mac地址以后，把数据发送到数据链路层传输，到这里，客户端发送请求阶段结束

#### 服务器接收报文

- 在数据链路层接收到请求，删除请求的首部信息，传输给网络层
- 网络层将收到的数据传给传输层
- 传输层将数据段按序号还原报文，传送给应用层
- 数据传输到应用层才是真正的接收到从客户端发送过来的http请求

#### 应用层 服务器发送http响应报文

服务器接收到客户端发送的请求后，查找请求的资源，并返回响应报文，响应报文最重要的信息： 状态码

- 200或2XX，请求成功
- 301， 永久重定向，同时也会反回一个重定向地址，请求资源已经永久转移
- 304， 请求缓存
- 404， not found,没有找到资源
- 405, 请求方式错误


## 页面渲染

#### 解析html以构建dom树

解析一个文档即将其转换为具有一定意义的结构(编码可以理解和使用的东西)。解析的结果通常是表达文档结构的节点树，称为解析树或语法树。
解析是以文档所遵循的语法规则（编写文档所用的语言或格式）为基础的。所有可以解析的格式都必须对应确定的语法（由词汇和语法规则构成）。这称为与上下文无关的语法。
解析的过程可以分成两个子过程：词法分析和语法分析。

词法分析是将输入内容分割成大量标记的过程。标记是语言中的词汇，即构成内容的单位。在人类语言中，它相当于语言字典中的单词。
语法分析是应用语言的语法规则的过程。
解析器通常将解析工作分给以下两个组件来处理：

词法分析器（有时也称为标记生成器），负责将输入内容分解成一个个有效标记；
而解析器负责根据语言的语法规则分析文档的结构，从而构建解析树。
由于不能使用常规的解析技术，浏览器就创建了自定义的解析器来解析 HTML。此解析算法由两个阶段组成：标记化和树构建。
具体的解析过程可参考![浏览器的工作原理](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/)中的标记化算法和构建树算法

解析器的输出“解析树”是由 DOM 元素和属性节点构成的树结构。DOM 是文档对象模型 (Document Object Model) 的缩写。它是 HTML 文档的对象表示，同时也是外部内容（例如 JavaScript）与 HTML 元素之间的接口。解析树的根节点是“Document”对象。

当解析到link标签时会请求相应的CSS文件，并将其CSS规则解析为StyleSheet对象，CSS文件中的其他外链资源如背景图片等只有等到其规则与DOM树某节点相匹配时才会加载
当解析遇到img标签时会根据路径向服务器相应的资源文件夹中请求图片资源，但并不会等待图片资源下载完再去解析接下来的html，而是并发执行即图片资源仍在下载，html解析也在进行。如果没有定义图片的height和width属性，那么浏览器为了能够显示每一个加载的图像，它需要先下载图像，然后解析出图像的高度和宽度，并在显示窗口留出相应的屏幕空间，这样就会导致浏览器不断地重新计算/调整页面的布局，这可能会延迟文档的显示，并导致页面重绘。
当解析遇到script标签时，将启动 JavaScript 引擎，这时将阻塞 DOM 树的构建。因为 JavaScript 执行过程中， JavaScript 很可能会对 DOM 树进行读写操作。直到 JavaScript 执行完毕（此时执行的是全局对象初始创建和全局上下文中代码的执行），DOM树才会恢复构建。

#### 构建render树

为了更好地用户体验效果，浏览器会在构建DOM树的同时，也在构建render树。
呈现树的每一个节点即为与其相对应的DOM节点的CSS框，框的类型与DOM节点的display属性有关，
block元素生成block框，
inline元素生成inline框。
每一个呈现树节点都有与之相对应的DOM节点，但DOM节点不一定有与之相对应的呈现树节点，比如display属性为none的DOM节点，
而且呈现树节点在呈现树中的位置与他们在DOM树中的位置不一定相同，比如float与绝对定位元素。
在构建render树的时候需要为DOM树匹配CSS规则，在这个阶段因为匹配规则是从右往左匹配的，所以css的编写规则很重要。
不好的CSS选择器写法会影响到页面渲染的效率，具体是如何编写高效的CSS规则的可参考这篇文章![CSS选择器性能分析](http://www.cnblogs.com/jesse131/p/6135773.html)

#### 布局render树

在创建render树时，并不包含位置和大小信息。计算这些值的过程称为布局或重排。布局是一个递归的过程，它从根元素开始，然后递归遍历部分或所有的框架层次结构，为每一个需要计算的呈现器计算几何信息。
布局通常具有以下模式：

- 父呈现器确定自己的宽度。
- 父呈现器依次处理子呈现器，并且：
  放置子呈现器（设置 x,y 坐标）。
  如果有必要，调用子呈现器的布局，这会计算子呈现器的高度。
- 父呈现器根据子呈现器的累加高度以及边距和补白的高度来设置自身高度，此值也可供父呈现器的父呈现器使用。
- 将其 dirty 位设置为 false

#### 绘制render树

在绘制阶段，系统会遍历render树，并调用呈现器的“paint”方法，将呈现器的内容显示在屏幕上。绘制工作是使用用户界面基础组件完成的。和布局一样，绘制也分为全局（绘制整个呈现树）和增量两种。在增量绘制中，部分呈现器发生了更改，但是不会影响整个树。更改后的呈现器将其在屏幕上对应的矩形区域设为无效，这导致 OS 将其视为一块“dirty 区域”，并生成“paint”事件。
绘制顺序:

- 背景颜色
- 背景图片
- 边框
- 子代
- 轮廓

#### 页面变化造成的影响

在发生变化时，浏览器会尽可能做出最小的响应。

- 元素的颜色改变后，只会对该元素进行重绘。
- 元素的位置改变后，只会对该元素及其子元素（可能还有同级元素）进行布局和重绘。
- 添加 DOM 节点后，会对该节点进行布局和重绘。
- 一些重大变化（例如增大“html”元素的字体）会导致缓存无效，使得整个呈现树都会进行重新布局和绘制。

#### 页面渲染阶段的优化：

- 将css文件放在头部，便于构建dom树
- 将javascript文件放在尾部，以免阻塞构建dom树
- javascript的onload事件里，不要写太多影响首屏渲染的、操作dom树的代码
- 精简js和css代码，是资源更快的下载
- 重要的图片或想让用户先看到的图片使用img标签，次要的可以使用background引入