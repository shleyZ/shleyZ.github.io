---
title: js闭包的特性和其优缺点
date: 2018-05-09 09:19:34
categories: javascript
tags: 闭包
---

javascript有 全局变量和局部变量

js的特点就是函数内部可以读取全局和局部变量，但是函数外部不能读取内部的局部变量  

这样就有闭包可以实现读取函数内部变量：在函数内部再定义一个函数

``` js
function f1() {
  let n = 99;
  function f2(){
    console.log(n)
  }
}
```

所以可以理解为闭包是一个外部访问内部变量的一个通道。


### 闭包的用途： 

1. 读取函数内部的变量

2. 让这些变量的值保存在内存中，不会被垃圾回收机制自动清除

### 优点：

1. 避免全局变量污染
2. 使变量长期保存在内存中

### 缺点

1. 增加内存使用量
2. 造成内存泄漏 （这些变量不会被垃圾回收机制自动清除），解决方法：在退出或者不用之后把局部变量手动清除

### 垃圾回收机制了解一下

js每次创建变量（字符串，对象，数组等）时，都会自动分配内存来存储这些变量，只要动态分配了内存，最终都要释放以便内存可以再次使用，否则js解释器就会消耗完系统的所有内存，造成系统崩溃。这就是为什么需要垃圾回收。

js 不像c/c++，有自己的一套垃圾回收机制，js只能进行检测，看这些变量什么时候不用了，不需要了就进行释放。

``` js
var a = "before";
var b = "override a";
var a = b; //重写a

```
上面的代码运行之后，"before"这个字符串失去了引用，系统检测到了之后，就会释放该字符串的存储空间以便这些空间可以被再利用。

1. 原理：标记清除 

当变量进入执行环境，标记为“进入环境”，当变量离开环境，标记为“离开环境”
垃圾收集器运行的时候，

- 会把所有的变量加上标记，
- 然后去掉所有在环境中的变量的标记，
- 如果有变量不用了，访问不到了，再给这些变量加上标记，视为将要删除的变量， 
- 垃圾回收器完成清除，销毁带有标记的变量，释放内存

2. 原理：引用计数

跟踪记录每个变量被引用的次数

- 当声明了一个变量并给他赋值，则这个值的引用次数为 1
- 反之，如果这个值对应的变量又取得另外一个值， 则原来这个值引用次数 -1
- 当引用次数为0时，说明访问不到这个值了，则销毁并回收

3. 引发内存泄漏的操作

- 意外的全局变量引起的内存泄漏
  
  原因: 全局变量，不会被回收

  解决方法： 使用严格模式，严格模式不允许意外创建全局变量（非严格模式下，错误的创建变量会导致创建为全局变量）

- 闭包引起内存泄漏

  原因： 可以维持函数内局部变量，使其得不到释放

- 没有清理的dom元素引用

  原因： 虽然别的地方删除了，但是对象中还存在对dom的引用

  解决方法： 手动删除引用