---
title: 科学上网
date: 2017-10-19 14:52:17
categories: Mac
---

 ### 科学上网：用 VPS 搭建 shadowsocks 服务器 

 目前 shadowsocks 服务已经受到了影响，不过部署在 25 端口目前还可用。

仍然可以通过 ubuntu 的 apt-get 获取到 shadowsocks 服务端，windows、Mac OS X、Android 客户端的 release 下载链接仍然保留。因此在写作本文时，shadowsocks 还是可以使用的。

#### shadowsocks 简介

shadowsocks 是一款自定义协议的代理软件，由于其流量特征不明显，（直到不久前）一直可以稳定提供上网代理。

shadowsocks 客户端会在本地开启一个 socks5 代理，通过此代理的网络访问请求由客户端发送至服务端，服务端发出请求，收到响应数据后再发回客户端。

因此使用 shadowsocks 需要一台墙外的服务器来部署 shadowsocks 服务端。

#### 购买 VPS 服务器

主流的 VPS（虚拟主机）服务器提供商有三家：

linode
digital ocean
bandwagon
下面的比上面的便宜。如果只是自用，bandwagon 足够。

一般使用 paypal 绑定一个 visa 或 mastercard 信用卡来付款。注意要用国际 paypal 帐号，国内的是不能用外币付款的。

在 bandwagon 购买 VPS 以后会获得一个主机地址和用于 ssh 登录的 root 密码。

#### 远程登陆 VPS

Mac OS X 或 Linux 下直接在终端中 ssh root@your_vps_ip -p your_ssh_port   即可。

在 windows 系统下需要专门的客户端来 SSH 登录 VPS。在 xShell 官网  下载 xShell。

家庭和学校用户可以免费试用，下载时选择 home and school use 即可。需要用邮箱注册一下，下载链接会发送到邮箱中。

xShell 中新建一个连接，会要求输入目标 IP 地址和端口，以及 root 密码，按提示操作即可。

#### 安装 shadowsocks

打开 shell，使用 VPS 服务商提供的 root 用户和密码 SSH 登录 VPS。然后执行如下命令：

Debian/Ubuntu:

    apt-get install python-pip
    pip install shadowsocks 

CentOS:

    yum install python-setuptools && easy_install pip
    pip install shadowsocks 

shadowsocks 就安装好了。

有时 Ubuntu 会遇到第一个命令安装 python-pip 时找不到包的情况。pip 官方给出了一个安装脚本，可以自动安装 pip。先下载脚本，然后执行即可：

    wget https://bootstrap.pypa.io/get-pip.py python get-pip.py 

#### 编写配置文件

shadowsocks 启动时的参数，如服务器端口，代理端口，登录密码等，可以通过启动时的命令行参数来设定，也可以通过 json 格式的配置文件设定。推荐使用配置文件，方便查看和修改。

用 vi 新建一个配置文件：

    vi /etc/shadowsocks.json 

然后输入如下内容：

    { 
       "server":"my_server_ip", 
       "server_port":25, 
       "local_address": "127.0.0.1", 
       "local_port":1080, 
       "password":"mypassword",
        "timeout":300, 
       "method":"aes-256-cfb", 
       "fast_open": false 
     } 

保存退出。

配置文件中个字段的含义：

server: 服务器ip地址
server_port: 绑定的端口，注意不要设置已经使用了的端口
possword: 密码
timeout: 超时时间
method: 加密方法
fast_open: 如果你的服务器 Linux 内核在3.7+，可以开启 fast_open 以降低延迟
workers: 默认为1


如果需要配置多个SS账号，可以按照如下案例进行配置：

    {
    "server":"your_server_ip",
    "port_password":{
         "8381":"password1",
         "8382":"password2",
         "8383":"password3",
         "8384":"password4"
         },
    "timeout":300,
    "method":"rc4-md5",
    "fast_open":false,
    "workers":1
    }



#### 启动 shadowsocks

如果已经写好了配置文件，启动 shadowsocks 服务器的命令如下：

    ssserver -c /etc/shadowsocks.json 

后台启动和停止 shadowsocks 服务器：

    ssserver -c /etc/shadowsocks.json -d start 
    ssserver -c /etc/shadowsocks.json -d stop 

shadowsocks 的日志保存在 /var/log/shadowsocks.log

安装并启动 shadowsocks 客户端

shadowsocks 支持 windows、Mac OS X、Linux、Android、iOS 等多个平台。不过 iOS 由于系统对应用后台运行的限制，推荐使用客户端内嵌的浏览器科学上网，给其他应用代理时需要每过几分钟重新启动一下 app。

shadowsocks 项目 Github 主页在这里。

里面可以找到客户端下载地址。

下载安装客户端以后，只需按服务器的配置填写 IP 地址、服务器端口、本地端口（如果没有本地端口选项，就是默认的 1080）、密码、加密方式等参数，启动就可以了。

客户端支持全局代理和 PAC 代理两种方式，后者会使用一个脚本来自动检查一个网站是否在需要代理的网站列表中，自动选择直接连接或代理连接。

PAC 列表可以在线更新，但是难免有收录不全的情况。这时可以选择关闭 shadowsocks 代理（实际上是取消对系统代理的配置，shadowsocks 客户端仍然保持工作），然后使用支持自定义规则的代理管理插件来实现自动切换代理，比如 switchyOmega。

#### 使用 switchyOmega 实现自动切换代理

switchyOmega 是 chrome 浏览器上一个很好用的代理管理插件。它的前身 switchySharp 更有名。

chrome 应用商店本身需要翻墙才能访问，因此需要先在 shadowsocks 启动代理模式下下载安装，再关闭 shadowsocks 代理。

安装完毕后，右击 switchyOmega 图标，选择选项，进入 switchOmega 配置界面。

创建 shadowsocks 情景模式

新建一个情景模式，比如叫 SS，代理协议选择 socks5，代理地址为 127.0.0.1，端口 1080。

现在切换到 SS 情景模式就可以通过 shadowsocks 科学上网了。后面获取自动切换规则列表

设置自动切换模式

在设置界面选择自动切换模式，在 “切换规则” 中勾选“规则列表规则”，对应的情景模式选择刚刚新建的 SS。

然后在下面的规则列表地址中填写

    https://autoproxy-gfwlist.googlecode.com/svn/trunk/gfwlist.txt

规则列表格式选择 AutoProxy。

然后点击立即更新情景模式， 更新完成后会有提示。

点击左侧的 “应用选项”。然后单击 switchyOmega 图标，选择自动切换，就可以在访问“不存在的网站” 时自动切换到 shadowsocks 代理了。

添加自定义规则

如果遇到某个国外网站无法直接连接或速度太慢时，可以单击 switchyOmega 图标，选择 “添加条件”，情景模式选择 SS，就可以了。

这时打开 switchyOmega 选项，在自动切换模式的切换规则中就可以看到刚刚添加的规则。可以在这里管理自定义的规则。

导入和导出 switchyOmega 设置

如果换了一台电脑，重新设置一遍 switchyOmega 就太麻烦了。可以在设置好的 switchyOmega 中导出设置文件，在另一个 chrome 浏览器中导入，就可以直接复制原来的设置了。

在 switchyOmega 选项的左侧点击 “导入 / 导出”，点击“生成备份文件” 即可生成 switchyOmega 设置备份。点击 “从备份文件恢复” 可以导入备份文件。

(apt install shadowsocks-libev

)


坑：

1.远程连接ubuntu系统时，可能会出现如下错误：

    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    @    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
    Someone could be eavesdropping on you right now (man-in-the-middle attack)!
    It is also possible that a host key has just been changed.
    The fingerprint for the ECDSA key sent by the remote host is
    SHA256:JHdZe0uj0FNj0PzyxFFNGZ5TU4M0aY/HsyTRON2CgQ4.
    Please contact your system administrator.
    Add correct host key in /Users/*****/.ssh/known_hosts to get rid of this message.
    Offending ECDSA key in /Users/*****/.ssh/known_hosts:6
    ECDSA host key for 45.77.195.128 has changed and you have requested strict checking.

这种情况可能是因为已经登陆过，但是你修改过了ubuntu系统的信息，导致ssh信息不一致，只需要找到.ssh文件（Mac系统里面使用command+shift+.来显示隐藏文件，一般.ssh文件就在个人文件夹里面），删除对应的ip信息就好。

2.在pip install shadowsocks时会出现error：

    ImportError: No module named setuptools

解决办法：

    wget http://pypi.python.org/packages/source/s/setuptools/setuptools-0.6c11.tar.gz
    tar zxvf setuptools-0.6c11.tar.gz
    cd setuptools-0.6c11
    python setup.py build
    python setup.py install

3.error: invalid command 'bdist_wheel'

解决办法：

    pip install setuptools --upgrade

